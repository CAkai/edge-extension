import{d as g,u as x,i as a,n as r}from"./user.store-F7xgAcIW.js";import{a as T,S as w}from"./index-lOtXKBCI.js";function y(e,t,o){return!e.startsWith("data:")&&!e.startsWith("blob:")&&!e.startsWith("http")?Promise.reject("Invalid data URL"):fetch(e).then(n=>n.blob()).then(n=>new File([n],t,{type:o}))}async function C(e){g("Upload",e);const o=(await x.get()).icloud.access_token,n=new FormData;return n.append("files",e),o?fetch("http://172.16.32.95/file-server/api/v1/files",{method:"POST",headers:{Authorization:`Bearer ${o}`,"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, PATCH, PUT, DELETE, OPTIONS","Access-Control-Allow-Headers":"X-Requested-With, X-Custom-Header, accept, Content-Type","Access-Control-Allow-Credentials":"true"},body:n}).then(i=>{if(!i.ok)throw i;return i.json()}):Promise.reject("no token")}function k(e,t,o){return y(e,t,o).then(n=>C(n)).then(n=>n.error===""?n.message:Promise.reject(n.error))}function I(e){const o=new RegExp(/^https?:\/\/.*\/(.*\.([jJ][pP][gG]|[pP][nN][gG]|[jJ][pP][eE][gG]))$/).exec(e);let n="image.png",i="image/png";return o&&(n=o[1].toLowerCase(),["jpg","jpeg"].includes(o[2].toLowerCase())&&(i="image/jpeg")),{fileName:n,fileType:i}}function d(e,t,o,n,i){chrome.notifications.create(e,{type:"basic",iconUrl:n,title:t,message:o},f=>{setTimeout(()=>{chrome.notifications.clear(f)},i)})}function c(e,t,o,n){switch(e){case"success":d(t,o,n,"images/check.png",5e3);break;case"error":d(t,o,n,"images/cancel.png",5e3);break;default:console.error("Unknown type",e);break}}var l=(e=>(e.Root="",e.Sidepanel="side-panel",e.SidepanelChat="side-panel/chat",e.SidepanelAuth="side-panel/auth",e))(l||{});const u=T("navigation-storage-key","",{storageEnum:w.Local,liveUpdate:!0}),h={...u,clear:async()=>{await u.set(l.Root)}};async function p(){const e=await h.get();return g(`Navigation: ${e}`),e===l.SidepanelChat}async function s(e,t){if(await chrome.sidePanel.open({windowId:e}),await p()){t();return}const o=setInterval(async()=>{await p()&&(clearInterval(o),t())},100)}function E(){chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0}).catch(e=>console.error(e)),chrome.runtime.onConnect.addListener(function(e){e.name===l.Sidepanel&&e.onDisconnect.addListener(async()=>{h.clear()})})}var v=(e=>(e.ASK="icloud-copilot-contextmenu-ask",e.TRANSLATE="icloud-copilot-contextmenu-translate",e.UPLOAD_IMAGE_TO_ICLOUD="icloud-copilot-contextmenu-upload-image",e.UPLOAD_IMAGE_TO_CHAT="icloud-copilot-contextmenu-upload-image-to-chat",e.NO_TOKEN="icloud-copilot-no-token",e))(v||{});function P(e,t,o){k(e,t,o).then(()=>{c("success",`icloud-copilot-contextmenu-upload-image-${crypto.randomUUID()}`,a("uploadImageToICloud"),a("uploadSuccess"))}).catch(async n=>{if(n==="no token"){c("error",`icloud-copilot-no-token-${crypto.randomUUID()}`,a("noLogin"),a("loginTitle"));return}c("error",`icloud-copilot-contextmenu-upload-image-${crypto.randomUUID()}`,a("uploadImageToICloud"),a("uploadFailed"))})}const m=[{id:"icloud-copilot-contextmenu-ask",title:a("ask_extensionName",a("extensionName")),contexts:["all"],onclick:(e,t)=>{const o=e.selectionText??"";s((t==null?void 0:t.windowId)??1,()=>{r({type:"clipboard",value:a("ask_extensionName",o)},n=>console.log(n))})}},{id:"icloud-copilot-contextmenu-translate",title:a("translate_extensionName",a("extensionName")),contexts:["all"],onclick:(e,t)=>{const o=e.selectionText??"";s((t==null?void 0:t.windowId)??1,()=>{r({type:"clipboard",value:a("translate_content",o)},n=>console.log(n))})}},{id:"icloud-copilot-contextmenu-upload-image",title:a("uploadImageToICloud"),contexts:["image"],onclick:e=>{const{fileName:t,fileType:o}=I(e.srcUrl??"");P(e.srcUrl??"",t,o)}},{id:"icloud-copilot-contextmenu-upload-image-to-chat",title:a("uploadImageToChat"),contexts:["image"],onclick:async(e,t)=>{if(!e.srcUrl){c("error",`icloud-copilot-contextmenu-upload-image-to-chat-${crypto.randomUUID()}`,a("uploadImageToChat"),a("uploadFailed"));return}s((t==null?void 0:t.windowId)??1,()=>{r({type:"upload-image",value:e.srcUrl},o=>console.log(o))})}}];function D(){chrome.runtime.onInstalled.addListener(()=>{m.map(e=>({id:e.id,title:e.title,contexts:e.contexts})).forEach(e=>{chrome.contextMenus.create(e)})}),chrome.contextMenus.onClicked.addListener((e,t)=>{var n;const o=m.find(i=>i.id===e.menuItemId);o&&((n=o.onclick)==null||n.call(o,e,t))})}export{v as C,l as N,E as a,c,y as d,I as g,h as n,D as r};
